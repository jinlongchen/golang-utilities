package util

import (
	"fmt"
	"github.com/paulmach/go.geojson"
	"testing"
)

func TestWGS84toGCJ02(t *testing.T) {
	x := tttt()
	fc, err := geojson.UnmarshalFeatureCollection([]byte(x))
	if err != nil {
		panic(err)
	}
	for _, feature := range fc.Features {
		if feature.Geometry.Type == geojson.GeometryPolygon {
			newPolygon := make([][][]float64, len(feature.Geometry.Polygon))
			for pointsIndex, points := range feature.Geometry.Polygon {
				newPolygon[pointsIndex] = make([][]float64, len(points))
				for pointIndex, point := range points {
					lon, lat := WGS84toGCJ02(point[0], point[1])
					newPolygon[pointsIndex][pointIndex] = []float64{
						lon, lat,
					}
					fmt.Printf("(%f,%f)->(%f,%f) (%f,%f)->(%f,%f)\n", point[0], point[1], lon, lat, point[1], point[0], lat, lon)
				}
			}
			feature.Geometry.Polygon = newPolygon
		}
	}
	data, _ := fc.MarshalJSON()

	println(string(data))
	//{"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[120.35188655393102,30.261637381084828],[120.35807463316596,30.260758315071808],[120.36237152087014,30.261061816297726],[120.36769912591679,30.262700905548748],[120.37629058658445,30.269236254856633],[120.38436475265523,30.281846872722763],[120.40479648286284,30.324248807770896],[120.40462509590881,30.326619836197388],[120.40874342892008,30.334918129173396],[120.4169776984386,30.353140204871],[120.42366572029701,30.370320443920637],[120.3999972282823,30.391950161064518],[120.38025146026037,30.38778961739118],[120.36564698083102,30.382883282151024],[120.34364402900711,30.37321808190978],[120.3176832895728,30.367095818546797],[120.29843167557554,30.34632309479519],[120.29568155043128,30.335354641975034],[120.29275924757825,30.316975194665904],[120.29052426984364,30.297259619581386],[120.29396023666078,30.296819452182522],[120.30409833321627,30.294166373484323],[120.3140667486224,30.287067837468747],[120.31853622095264,30.2870759163519],[120.32678766674694,30.280420175057426],[120.35188655393102,30.261637381084828]]]},"properties":null}]}
}

func tttt() string {
	geojsonStr := `{
    "type": "FeatureCollection",
    "features": [
        {
            "type": "Feature",
            "properties": {},
            "geometry": {
                "type": "Polygon",
                "coordinates": [
                    [
                        [
                            120.34732818603516,
                            30.26396010698428
                        ],
                        [
                            120.35350799560547,
                            30.263070506250088
                        ],
                        [
                            120.35779953002931,
                            30.26336704072365
                        ],
                        [
                            120.36312103271484,
                            30.264997964321065
                        ],
                        [
                            120.3717041015625,
                            30.271521387805628
                        ],
                        [
                            120.3797721862793,
                            30.28412222826443
                        ],
                        [
                            120.40019989013672,
                            30.326508465902158
                        ],
                        [
                            120.40002822875977,
                            30.328879182541336
                        ],
                        [
                            120.40414810180664,
                            30.33717623884859
                        ],
                        [
                            120.4123878479004,
                            30.355397662121728
                        ],
                        [
                            120.41908264160156,
                            30.372578984886143
                        ],
                        [
                            120.39539337158203,
                            30.394199462058317
                        ],
                        [
                            120.37565231323242,
                            30.390053439904577
                        ],
                        [
                            120.36106109619142,
                            30.385166830762778
                        ],
                        [
                            120.3390884399414,
                            30.37554097682019
                        ],
                        [
                            120.31316757202148,
                            30.36946879677073
                        ],
                        [
                            120.29394149780272,
                            30.348731681299967
                        ],
                        [
                            120.29119491577147,
                            30.337768858825104
                        ],
                        [
                            120.28827667236328,
                            30.319395971697134
                        ],
                        [
                            120.28604507446288,
                            30.2996857382589
                        ],
                        [
                            120.28947830200195,
                            30.299241100818417
                        ],
                        [
                            120.29960632324219,
                            30.29657323383411
                        ],
                        [
                            120.30956268310545,
                            30.289458567037553
                        ],
                        [
                            120.31402587890625,
                            30.289458567037553
                        ],
                        [
                            120.32226562500001,
                            30.282788098216884
                        ],
                        [
                            120.34732818603516,
                            30.26396010698428
                        ]
                    ]
                ]
            }
        }
    ]
}`
	return geojsonStr
}
